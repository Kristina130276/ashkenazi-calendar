<script>
(async function () {
  // ====== Location: Israel (Ofakim) ======
  const geonameid = 293992;

  // ====== Today (local) ======
  const now = new Date();

  // ====== Gregorian date: DD.MM.YYYY ======
  const d = String(now.getDate()).padStart(2, '0');
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const y = now.getFullYear();
  document.getElementById('gregorian-date').textContent = `${d}.${m}.${y}`;

  // ====== ISO date for API ======
  const isoDate = `${y}-${m}-${d}`;

  try {
    // ====== Hebrew date ======
    const convUrl = `https://www.hebcal.com/converter?cfg=json&date=${isoDate}&g2h=1&strict=1`;
    const conv = await (await fetch(convUrl)).json();
    document.getElementById('hebrewDate').textContent = conv.hebrew;

    // ====== Melacha status ======
    const zmanimUrl = `https://www.hebcal.com/zmanim?cfg=json&geonameid=${geonameid}`;
    const zmanim = await (await fetch(zmanimUrl)).json();

    const stEl = document.getElementById('melachaStatus');
    if (zmanim?.status?.isAssurBemelacha === true) {
      stEl.textContent = 'אסור מלאכה עכשיו';
      stEl.className = 'status no';
    } else {
      stEl.textContent = 'מותר מלאכה עכשיו';
      stEl.className = 'status ok';
    }

    // ====== Events today ======
    const calUrl =
      `https://www.hebcal.com/hebcal?v=1&cfg=json&maj=on&min=on&mod=on&nx=on&mf=on&ss=on` +
      `&start=${isoDate}&end=${isoDate}&lg=he&geo=geoname&geonameid=${geonameid}`;

    const cal = await (await fetch(calUrl)).json();
    const items = (cal.items || []);

    const eventsBox = document.getElementById('eventsBox');
    eventsBox.innerHTML = '';

    // ====== Ashkenazi MVP labels ======
    const ashkenaziNotes = [];

    // 1) Selichot (Ashkenazi) — informational MVP
    // We mark it textually (no heavy calculations in MVP)
    ashkenaziNotes.push('תחילת סליחות — מנהג אשכנז (לפי המנהג)');

    // 2) Mourning periods — informational MVP
    ashkenaziNotes.push('ספירת העומר — מנהגי אבלות (אשכנז)');
    ashkenaziNotes.push('בין המצרים / תשעת הימים — לפי מנהג אשכנז');

    // Render Hebcal events (holidays/parashat)
    const ul = document.createElement('ul');

    for (const it of items) {
      if (
        it.category === 'holiday' ||
        it.category === 'parashat' ||
        it.category === 'roshchodesh'
      ) {
        const li = document.createElement('li');
        li.textContent = it.title;
        ul.appendChild(li);
      }
    }

    // Render Ashkenazi MVP notes
    for (const note of ashkenaziNotes) {
      const li = document.createElement('li');
      li.textContent = note;
      ul.appendChild(li);
    }

    if (ul.children.length === 0) {
      eventsBox.textContent = 'אין אירועים מיוחדים היום';
    } else {
      eventsBox.appendChild(ul);
    }

    // ====== Ashkenazi label (positioning) ======
    const small = document.querySelector('.small');
    if (small) {
      small.textContent = 'לוח שנה יהודי — לפי מנהג אשכנז (MVP)';
    }

  } catch (err) {
    console.error(err);
    document.getElementById('eventsBox').textContent = 'שגיאה בטעינת נתונים';
    document.getElementById('melachaStatus').textContent = 'שגיאה בטעינת נתונים';
    document.getElementById('hebrewDate').textContent = 'שגיאה בטעינת נתונים';
  }
})();
</script>
